// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(cuid())
  name        String
  email       String   @unique
  password    String   // Store hashed password directly
  age         Int
  gender      String   // "male" or "female"
  city        String?
  state       String?
  country     String?
  latitude    Float?
  longitude   Float?
  bio         String?
  profileComplete Boolean @default(false) @map("profile_complete")
  profilePhotoUrl String? @map("profile_photo_url")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  lastActive  DateTime @default(now()) @map("last_active")
  
  // Terms and privacy agreement
  agreedToTerms   Boolean @default(false) @map("agreed_to_terms")
  agreedToPrivacy Boolean @default(false) @map("agreed_to_privacy")
  
  // Privacy settings (stored as text/strings for SQLite)
  blurFaceUntilConsent Boolean @default(false) @map("blur_face_until_consent")
  restrictByLocation   Boolean @default(false) @map("restrict_by_location")
  optOutOfLeaderboards Boolean @default(false) @map("opt_out_of_leaderboards")
  limitDemographicData Boolean @default(false) @map("limit_demographic_data")
  
  // Notification settings
  emailNotifications   Boolean @default(true) @map("email_notifications")
  pushNotifications    Boolean @default(true) @map("push_notifications")
  rankingUpdates       Boolean @default(true) @map("ranking_updates")
  newComparisons       Boolean @default(true) @map("new_comparisons")
  achievementNotifications Boolean @default(true) @map("achievement_notifications")
  
  // Comparison settings
  dailyLimit      Int     @default(20) @map("daily_limit")
  skipPenalty     Boolean @default(false) @map("skip_penalty")
  qualityFilter   Boolean @default(true) @map("quality_filter")
  
  // Relations
  photos        Photo[]
  comparisons   Comparison[] @relation("RaterComparisons")
  sessions      ComparisonSession[]
  achievements  Achievement[]
  rankings      PhotoRanking[]
  
  @@map("users")
}

model Photo {
  id              String      @id @default(cuid())
  userId          String      @map("user_id")
  url             String
  thumbnailUrl    String?     @map("thumbnail_url")
  status          String      @default("pending") // "pending", "approved", "rejected", "processing", "active", "inactive"
  originalFilename String     @map("original_filename")
  fileSize        Int         @map("file_size")
  width           Int
  height          Int
  format          String
  uploadedAt      DateTime    @default(now()) @map("uploaded_at")
  moderatedAt     DateTime?   @map("moderated_at")
  rejectionReason String?     @map("rejection_reason")
  
  // Relations
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  ranking         PhotoRanking?
  winnerComparisons Comparison[] @relation("WinnerComparisons")
  loserComparisons  Comparison[] @relation("LoserComparisons")
  
  @@map("photos")
}

model PhotoRanking {
  id                 String   @id @default(cuid())
  photoId            String   @unique @map("photo_id")
  userId             String   @map("user_id")
  currentPercentile  Float    @default(50.0) @map("current_percentile")
  totalComparisons   Int      @default(0) @map("total_comparisons")
  wins               Int      @default(0)
  losses             Int      @default(0)
  bradleyTerryScore  Float    @default(0.5) @map("bradley_terry_score")
  confidence         Float    @default(0.0)
  lastUpdated        DateTime @default(now()) @map("last_updated")
  
  // Relations
  photo              Photo    @relation(fields: [photoId], references: [id], onDelete: Cascade)
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  history            PercentileHistory[]
  
  @@map("photo_rankings")
}

model PercentileHistory {
  id         String   @id @default(cuid())
  rankingId  String   @map("ranking_id")
  percentile Float
  comparisons Int
  recordedAt DateTime @default(now()) @map("recorded_at")
  
  // Relations
  ranking    PhotoRanking @relation(fields: [rankingId], references: [id], onDelete: Cascade)
  
  @@map("percentile_history")
}

model Comparison {
  id               String   @id @default(cuid())
  raterId          String   @map("rater_id")
  winnerPhotoId    String   @map("winner_photo_id")
  loserPhotoId     String   @map("loser_photo_id")
  sessionId        String   @map("session_id")
  reliabilityWeight Float   @default(1.0) @map("reliability_weight")
  timestamp        DateTime @default(now())
  
  // Context metadata (stored as separate fields for SQLite)
  source           String   @default("mobile")
  devicePlatform   String?  @map("device_platform")
  deviceVersion    String?  @map("device_version")
  
  // Relations
  rater            User     @relation("RaterComparisons", fields: [raterId], references: [id])
  winnerPhoto      Photo    @relation("WinnerComparisons", fields: [winnerPhotoId], references: [id])
  loserPhoto       Photo    @relation("LoserComparisons", fields: [loserPhotoId], references: [id])
  session          ComparisonSession @relation(fields: [sessionId], references: [id])
  
  @@map("comparisons")
}

model ComparisonSession {
  id                  String   @id @default(cuid())
  userId              String   @map("user_id")
  startedAt           DateTime @default(now()) @map("started_at")
  endedAt             DateTime? @map("ended_at")
  comparisonsCompleted Int      @default(0) @map("comparisons_completed")
  comparisonsSkipped   Int      @default(0) @map("comparisons_skipped")
  averageResponseTime  Float?   @map("average_response_time")
  reliability         Float?   @default(1.0)
  
  // Relations
  user                User       @relation(fields: [userId], references: [id])
  comparisons         Comparison[]
  
  @@map("comparison_sessions")
}

model Achievement {
  id          String           @id @default(cuid())
  userId      String           @map("user_id")
  type        String           // "engagement", "consistency", "milestone", "social"
  title       String
  description String
  icon        String
  unlockedAt  DateTime         @default(now()) @map("unlocked_at")
  
  // Relations
  user        User             @relation(fields: [userId], references: [id])
  
  @@map("achievements")
}

model ModerationFlag {
  id          String   @id @default(cuid())
  photoId     String   @map("photo_id")
  flagType    String   @map("flag_type")
  description String
  severity    String   // "low", "medium", "high"
  confidence  Float
  createdAt   DateTime @default(now()) @map("created_at")
  reviewedAt  DateTime? @map("reviewed_at")
  reviewedBy  String?   @map("reviewed_by")
  
  @@map("moderation_flags")
}