// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(cuid())
  name        String
  email       String   @unique
  password    String   // Store hashed password directly
  age         Int?
  gender      String?   // "male" or "female" - auto-detected from photo
  city        String?
  state       String?
  country     String?
  latitude    Float?
  longitude   Float?
  bio         String?
  profileComplete Boolean @default(false) @map("profile_complete")
  profilePhotoUrl String? @map("profile_photo_url")
  isActive    Boolean  @default(true) @map("is_active")
  isAdmin     Boolean  @default(false) @map("is_admin")
  createdAt   DateTime @default(now()) @map("created_at")
  lastActive  DateTime @default(now()) @map("last_active")
  
  
  // Privacy settings (stored as text/strings for SQLite)
  blurFaceUntilConsent Boolean @default(false) @map("blur_face_until_consent")
  restrictByLocation   Boolean @default(false) @map("restrict_by_location")
  optOutOfLeaderboards Boolean @default(false) @map("opt_out_of_leaderboards")
  limitDemographicData Boolean @default(false) @map("limit_demographic_data")
  agreedToTerms        Boolean @default(false) @map("agreed_to_terms")
  agreedToPrivacy      Boolean @default(false) @map("agreed_to_privacy")
  
  // Notification settings
  emailNotifications   Boolean @default(true) @map("email_notifications")
  pushNotifications    Boolean @default(true) @map("push_notifications")
  rankingUpdates       Boolean @default(true) @map("ranking_updates")
  newComparisons       Boolean @default(true) @map("new_comparisons")
  achievementNotifications Boolean @default(true) @map("achievement_notifications")
  
  // Comparison settings
  dailyLimit      Int     @default(20) @map("daily_limit")
  skipPenalty     Boolean @default(false) @map("skip_penalty")
  qualityFilter   Boolean @default(true) @map("quality_filter")
  
  // Matching settings
  matchingPercentile Int @default(20) @map("matching_percentile") // Match with people in top n%
  
  // Relations
  photos        Photo[]
  comparisons   Comparison[] @relation("RaterComparisons")
  sessions      ComparisonSession[]
  achievements  Achievement[]
  rankings      PhotoRanking[]
  combinedRankings CombinedRanking[]
  
  // New Friends relations
  friendshipsInitiated Friendship[] @relation("FriendshipInitiator")
  friendshipsReceived  Friendship[] @relation("FriendshipReceiver")

  // Challenge relations
  challengesInitiated    Challenge[]     @relation("ChallengesInitiated")
  challengesReceived     Challenge[]     @relation("ChallengesReceived")
  challengeVotesCast     ChallengeVote[] @relation("ChallengeVotesCast")
  challengeVotesReceived ChallengeVote[] @relation("ChallengeVotesReceived")

  // Message relations
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")

  // Invite token relations
  inviteTokensCreated InviteToken[] @relation("InviteTokensCreated")
  inviteTokensUsed    InviteToken[] @relation("InviteTokensUsed")

  @@map("users")
}

model Photo {
  id              String      @id @default(cuid())
  userId          String      @map("user_id")
  url             String
  thumbnailUrl    String?     @map("thumbnail_url")
  status          String      @default("pending") // "pending", "approved", "rejected", "processing", "active", "inactive"
  originalFilename String     @map("original_filename")
  fileSize        Int         @map("file_size")
  width           Int
  height          Int
  format          String
  uploadedAt      DateTime    @default(now()) @map("uploaded_at")
  moderatedAt     DateTime?   @map("moderated_at")
  rejectionReason String?     @map("rejection_reason")
  
  // Relations
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  ranking         PhotoRanking?
  combinedRanking CombinedRanking?
  winnerComparisons Comparison[] @relation("WinnerComparisons")
  loserComparisons  Comparison[] @relation("LoserComparisons")
  
  @@index([userId])
  @@index([url])
  @@index([status])
  @@map("photos")
}

model PhotoRanking {
  id                 String   @id @default(cuid())
  photoId            String   @unique @map("photo_id")
  userId             String   @map("user_id")
  currentPercentile  Float    @default(50.0) @map("current_percentile")
  totalComparisons   Int      @default(0) @map("total_comparisons")
  wins               Int      @default(0)
  losses             Int      @default(0)
  bradleyTerryScore  Float    @default(0.5) @map("bradley_terry_score")
  // Trophy system fields
  trophyScore        Float    @default(0) @map("trophy_score")
  hiddenBradleyTerryScore Float @default(0) @map("hidden_bradley_terry_score")
  targetTrophyScore  Float?   @map("target_trophy_score")
  confidence         Float    @default(0.0)
  lastUpdated        DateTime @default(now()) @map("last_updated")
  
  // Relations
  photo              Photo    @relation(fields: [photoId], references: [id], onDelete: Cascade)
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  history            PercentileHistory[]
  
  @@index([trophyScore])
  @@map("photo_rankings")
}

model PercentileHistory {
  id         String   @id @default(cuid())
  rankingId  String   @map("ranking_id")
  percentile Float
  comparisons Int
  recordedAt DateTime @default(now()) @map("recorded_at")
  
  // Relations
  ranking    PhotoRanking @relation(fields: [rankingId], references: [id], onDelete: Cascade)
  
  @@map("percentile_history")
}

model Comparison {
  id               String   @id @default(cuid())
  raterId          String   @map("rater_id")
  
  // For user photos (nullable when comparing sample images)
  winnerPhotoId    String?  @map("winner_photo_id")
  loserPhotoId     String?  @map("loser_photo_id")
  
  // For sample images (nullable when comparing user photos)
  winnerSampleImageId String? @map("winner_sample_image_id")
  loserSampleImageId  String? @map("loser_sample_image_id")
  
  // Comparison type to track what's being compared
  comparisonType   String   @default("user_photos") @map("comparison_type") // "user_photos", "sample_images", "mixed"
  
  sessionId        String   @map("session_id")
  reliabilityWeight Float   @default(1.0) @map("reliability_weight")
  timestamp        DateTime @default(now())
  
  // Context metadata (stored as separate fields for SQLite)
  source           String   @default("mobile")
  devicePlatform   String?  @map("device_platform")
  deviceVersion    String?  @map("device_version")
  
  // Trophy deltas for battle log
  winnerTrophyDelta Float?   @map("winner_trophy_delta")
  loserTrophyDelta  Float?   @map("loser_trophy_delta")
  
  // Relations
  rater            User     @relation("RaterComparisons", fields: [raterId], references: [id])
  winnerPhoto      Photo?   @relation("WinnerComparisons", fields: [winnerPhotoId], references: [id])
  loserPhoto       Photo?   @relation("LoserComparisons", fields: [loserPhotoId], references: [id])
  winnerSampleImage SampleImage? @relation("WinnerSampleComparisons", fields: [winnerSampleImageId], references: [id])
  loserSampleImage  SampleImage? @relation("LoserSampleComparisons", fields: [loserSampleImageId], references: [id])
  session          ComparisonSession @relation(fields: [sessionId], references: [id])
  
  @@index([raterId])
  @@index([winnerPhotoId])
  @@index([loserPhotoId])
  @@index([winnerSampleImageId])
  @@index([loserSampleImageId])
  @@map("comparisons")
}

model ComparisonSession {
  id                  String   @id @default(cuid())
  userId              String   @map("user_id")
  startedAt           DateTime @default(now()) @map("started_at")
  endedAt             DateTime? @map("ended_at")
  comparisonsCompleted Int      @default(0) @map("comparisons_completed")
  comparisonsSkipped   Int      @default(0) @map("comparisons_skipped")
  averageResponseTime  Float?   @map("average_response_time")
  reliability         Float?   @default(1.0)
  
  // Relations
  user                User       @relation(fields: [userId], references: [id])
  comparisons         Comparison[]
  
  // Index for efficient session queries by user and date
  @@index([userId, startedAt])
  @@map("comparison_sessions")
}

model Achievement {
  id          String           @id @default(cuid())
  userId      String           @map("user_id")
  type        String           // "engagement", "consistency", "milestone", "social"
  title       String
  description String
  icon        String
  unlockedAt  DateTime         @default(now()) @map("unlocked_at")
  
  // Relations
  user        User             @relation(fields: [userId], references: [id])
  
  @@map("achievements")
}

model ModerationFlag {
  id          String   @id @default(cuid())
  photoId     String   @map("photo_id")
  flagType    String   @map("flag_type")
  description String
  severity    String   // "low", "medium", "high"
  confidence  Float
  createdAt   DateTime @default(now()) @map("created_at")
  reviewedAt  DateTime? @map("reviewed_at")
  reviewedBy  String?   @map("reviewed_by")
  
  @@map("moderation_flags")
}

model SampleImage {
  id              String      @id @default(cuid())
  url             String
  thumbnailUrl    String?     @map("thumbnail_url")
  gender          String      // "male", "female", "other"
  estimatedAge    Int         @map("estimated_age")
  source          String      // "unsplash", "generated", "curated", etc.
  description     String?     // Optional description of the image
  isActive        Boolean     @default(true) @map("is_active")
  createdAt       DateTime    @default(now()) @map("created_at")
  lastUsed        DateTime?   @map("last_used")
  
  // Relations
  ranking         SampleImageRanking?
  combinedRanking CombinedRanking?
  winnerComparisons Comparison[] @relation("WinnerSampleComparisons")
  loserComparisons  Comparison[] @relation("LoserSampleComparisons")
  
  @@map("sample_images")
}

model SampleImageRanking {
  id                 String      @id @default(cuid())
  sampleImageId      String      @unique @map("sample_image_id")
  currentPercentile  Float       @default(50.0) @map("current_percentile")
  totalComparisons   Int         @default(0) @map("total_comparisons")
  wins               Int         @default(0)
  losses             Int         @default(0)
  bradleyTerryScore  Float       @default(0.5) @map("bradley_terry_score")
  // Trophy system fields
  trophyScore        Float       @default(0) @map("trophy_score")
  hiddenBradleyTerryScore Float  @default(0) @map("hidden_bradley_terry_score")
  targetTrophyScore  Float?      @map("target_trophy_score")
  confidence         Float       @default(0.0)
  lastUpdated        DateTime    @default(now()) @map("last_updated")
  
  // Relations
  sampleImage        SampleImage @relation(fields: [sampleImageId], references: [id], onDelete: Cascade)
  
  @@map("sample_image_rankings")
}

model CombinedRanking {
  id                    String   @id @default(cuid())
  // Either photoId OR sampleImageId will be set, not both
  photoId               String?  @map("photo_id")
  sampleImageId         String?  @map("sample_image_id")
  userId                String?  @map("user_id") // Null for sample images
  gender                String   // "male" or "female"
  currentPercentile     Float    @default(50.0) @map("current_percentile")
  totalComparisons      Int      @default(0) @map("total_comparisons")
  wins                  Int      @default(0)
  losses                Int      @default(0)
  bradleyTerryScore     Float    @default(0.5) @map("bradley_terry_score")
  // Trophy system fields
  trophyScore           Float    @default(0) @map("trophy_score")
  hiddenBradleyTerryScore Float  @default(0) @map("hidden_bradley_terry_score")
  targetTrophyScore     Float?   @map("target_trophy_score")
  confidence            Float    @default(0.0)
  lastUpdated           DateTime @default(now()) @map("last_updated")
  
  // Relations (optional, since either photo OR sample image)
  photo                 Photo?        @relation(fields: [photoId], references: [id], onDelete: Cascade)
  sampleImage           SampleImage?  @relation(fields: [sampleImageId], references: [id], onDelete: Cascade)
  user                  User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  history               CombinedRankingHistory[]
  
  // Ensure exactly one of photoId or sampleImageId is set
  @@unique([photoId]) // Each photo can only have one combined ranking
  @@unique([sampleImageId]) // Each sample image can only have one combined ranking
  @@map("combined_rankings")
}

model CombinedRankingHistory {
  id                String          @id @default(cuid())
  combinedRankingId String          @map("combined_ranking_id")
  percentile        Float
  comparisons       Int
  recordedAt        DateTime        @default(now()) @map("recorded_at")
  
  // Relations
  combinedRanking   CombinedRanking @relation(fields: [combinedRankingId], references: [id], onDelete: Cascade)
  
  @@map("combined_ranking_history")
}

model TrophyConfig {
  id              String   @id @default(cuid())
  configName      String   @unique // "default", allows for future config variations
  
  // Trophy system constants (from ranking_system_concept.py)
  winGain         Float    @default(35) @map("win_gain")           // WIN_GAIN
  lossPenalty     Float    @default(25) @map("loss_penalty")       // LOSS_PENALTY
  targetMean      Float    @default(1500) @map("target_mean")       // TARGET_MEAN
  targetStd       Float    @default(430) @map("target_std")         // TARGET_STD
  fadeWidth       Float    @default(300) @map("fade_width")         // FADE_WIDTH
  learningRate    Float    @default(0.05) @map("learning_rate")    // K_BT
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@map("trophy_config")
}

model Friendship {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  friendId    String   @map("friend_id")
  status      String   @default("pending") // "pending", "accepted", "declined", "blocked"
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  user        User     @relation("FriendshipInitiator", fields: [userId], references: [id], onDelete: Cascade)
  friend      User     @relation("FriendshipReceiver", fields: [friendId], references: [id], onDelete: Cascade)

  @@unique([userId, friendId])
  @@map("friendships")
}

model Challenge {
  id              String    @id @default(cuid())
  challengerId    String    @map("challenger_id")
  challengedId    String    @map("challenged_id")
  status          String    @default("pending") // "pending", "active", "completed", "declined"
  votesRequired   Int       @default(10) @map("votes_required")
  challengerVotes Int       @default(0) @map("challenger_votes")
  challengedVotes Int       @default(0) @map("challenged_votes")
  winnerId        String?   @map("winner_id")
  createdAt       DateTime  @default(now()) @map("created_at")
  acceptedAt      DateTime? @map("accepted_at")
  completedAt     DateTime? @map("completed_at")

  // Relations
  challenger      User            @relation("ChallengesInitiated", fields: [challengerId], references: [id], onDelete: Cascade)
  challenged      User            @relation("ChallengesReceived", fields: [challengedId], references: [id], onDelete: Cascade)
  votes           ChallengeVote[]

  @@index([challengerId])
  @@index([challengedId])
  @@index([status])
  @@map("challenges")
}

model ChallengeVote {
  id           String   @id @default(cuid())
  challengeId  String   @map("challenge_id")
  voterId      String   @map("voter_id")
  chosenUserId String   @map("chosen_user_id")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  challenge    Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  voter        User      @relation("ChallengeVotesCast", fields: [voterId], references: [id], onDelete: Cascade)
  chosenUser   User      @relation("ChallengeVotesReceived", fields: [chosenUserId], references: [id], onDelete: Cascade)

  @@unique([challengeId, voterId])
  @@index([challengeId])
  @@map("challenge_votes")
}

model Message {
  id         String   @id @default(cuid())
  senderId   String   @map("sender_id")
  receiverId String   @map("receiver_id")
  content    String
  isRead     Boolean  @default(false) @map("is_read")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  sender     User @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver   User @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([receiverId, isRead])
  @@index([senderId, receiverId])
  @@map("messages")
}

model InviteToken {
  id          String    @id @default(cuid())
  token       String    @unique @default(cuid())
  creatorId   String    @map("creator_id")
  usedById    String?   @map("used_by_id")
  usedAt      DateTime? @map("used_at")
  expiresAt   DateTime? @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  creator     User      @relation("InviteTokensCreated", fields: [creatorId], references: [id], onDelete: Cascade)
  usedBy      User?     @relation("InviteTokensUsed", fields: [usedById], references: [id], onDelete: SetNull)

  @@index([token])
  @@index([creatorId])
  @@map("invite_tokens")
}